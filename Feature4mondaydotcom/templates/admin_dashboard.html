{% extends "base.html" %} {% block content %}

<h1>Admin Dashboard</h1>
<div style="width: 500px; height: 300px; border: 1px solid black">
  <h2>Users</h2>
  <ul>
    {% for user in users %}
    <li>
      <img src="{{ user|profile_pic_url }}" alt="{{ user.username }}'s profile picture" style="width: 50px; height: 50px; object-fit: cover;">
      <a href="{{ url_for('user_profile', user_id=user.id) }}">{{ user.username }}</a> ({{ user.email }})
    </li>
    {% endfor %}
  </ul>
</div>
</div>

<h2>Add New Project</h2>
<form method="POST">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <input type="text" name="project_name" placeholder="Project Name" required />
  <textarea
    name="project_description"
    placeholder="Project Description"
  ></textarea>
  <button type="submit" name="add_project">Add Project</button>
</form>

<div
  style="
    width: 500px;
    height: 300px;
    border: 1px solid black;
    align-items: center;
  "
>
  <h2>All Projects</h2>
  {% for project in projects %}
  <div class="project-item" data-project-id="{{ project.id }}">
    <span>{{ project.name }} - {{ project.description }}</span>
    <button class="delete-project" data-project-id="{{ project.id }}">
      Delete Project
    </button>
  </div>
  {% endfor %}
</div>
<h2>Add New Task</h2>
<form method="POST" enctype="multipart/form-data" id="addTaskForm">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <select name="project_id" required>
    {% for project in projects %}
    <option value="{{ project.id }}">{{ project.name }}</option>
    {% endfor %}
  </select>
  <input type="text" name="task_title" placeholder="Task Title" required />
  <textarea name="task_description" placeholder="Task Description"></textarea>
  <select name="task_status" required>
    <option value="To Do">To Do</option>
    <option value="In Progress">In Progress</option>
    <option value="Done">Done</option>
  </select>
  <input type="date" name="due_date" required />
  <button type="button" id="openAssignUsersModal">Assign Users</button>
  <input type="file" name="files[]" multiple />
  <button type="submit" name="add_task">Add Task</button>
</form>

<div id="assignUsersModal" class="modal">
  <div class="modal-content">
    <h2>Assign Users</h2>
    {% for user in users %}
    <label>
      <input type="checkbox" name="assigned_to" value="{{ user.id }}" /> {{
      user.username }} </label
    ><br />
    {% endfor %}
    <button id="saveAssignedUsers">Save</button>
    <button id="closeModal">Cancel</button>
  </div>
</div>

<h2>All Tasks</h2>
{% for task in tasks %}
<div class="task-item">
  <h3>{{ task.title }} - {{ task.status }}</h3>
  <p>{{ task.description }}</p>
  <p>Due date: {{ task.due_date.strftime('%Y-%m-%d') }}</p>
  <p>Time spent: {{ task.formatted_time_spent }}</p>
  <p>
    Assigned to: {% for user in task.assigned_users %} {{ user.username }}{% if
    not loop.last %}, {% endif %} {% endfor %}
  </p>
  {% if task.files %}
  <h4>Uploaded Files:</h4>
  <ul class="uploaded-files">
    {% for file in task.files %}
    <li class="uploaded-file">
      {% if file.file_type == 'image' %}
      <img
        src="{{ url_for('serve_file', file_id=file.id) }}"
        alt="Uploaded image"
        class="uploaded-image"
      />
      {% endif %}
      <a href="{{ url_for('download_file', file_id=file.id) }}"
        >{{ file.filename }}</a
      >
      <button class="delete-file-btn" data-file-id="{{ file.id }}">
        Delete File
      </button>
    </li>
    {% endfor %}
  </ul>
  {% endif %}
  <form
    action="{{ url_for('delete_task', task_id=task.id) }}"
    method="POST"
    onsubmit="return confirm('Are you sure you want to delete this task?');"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <button type="submit">Delete Task</button>
  </form>
</div>
{% endfor %} {% endblock %}
