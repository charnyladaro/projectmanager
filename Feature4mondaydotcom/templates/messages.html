{% extends "base.html" %} {% block content %}

    <div class="friends-list">
        <h3>Your Friends</h3>
        {% if friends %} {% for friend in friends %}
        <div class="friend-item">
          {{ friend.username }}
          <a href="{{ url_for('messages', user_id=friend.id) }}">Start Chat</a>
        </div>
        {% endfor %} {% else %}
        <p>You don't have any friends yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="pending-requests">
      <h3>Pending Requests</h3>
      {% if requests %} {% for request in requests %}
      <div class="request-item">
        {{ request.sender.username }} wants to {{ request.request_type }} with
        you
        <a
          href="{{ url_for('handle_request', request_id=request.id, action='accept') }}"
          >Accept</a
        >
        <a
          href="{{ url_for('handle_request', request_id=request.id, action='reject') }}"
          >Reject</a
        >
      </div>
      {% endfor %} {% else %}
      <p>No pending requests.</p>
      {% endif %}
    </div>


    {% if chat_user %}
    <h2>Chat with {{ chat_user.username }}</h2>
    <div class="message-container">
      {% for message in messages %}
      <div
        class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}"
      >
        <strong>{{ message.sender.username }}:</strong> {{ message.content }}
        <span class="timestamp"
          >{{ message.timestamp.strftime('%I:%M %p') }}</span
        >
        {% if message.files %}
        <div class="file-attachments">
          {% for file in message.files %} {% if file.file_type == 'image' %}
          <img
            src="{{ url_for('serve_image', filename=file.filename) }}"
            class="chat-image"
            style="max-width: 200px; max-height: 200px; cursor: pointer"
          />
          {% else %}
          <a href="{{ url_for('download_file', file_id=file.id) }}"
            >{{ file.filename }}</a
          >
          {% endif %} {% endfor %}
        </div>
        {% endif %} 
        {% if message.sender_id == current_user.id %}
            <form id="deleteForm{{ message.id }}" action="{{ url_for('delete_message', message_id=message.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="confirmation" value="false" id="confirmationInput{{ message.id }}" />
                <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete({{ message.id }})">Delete</button>
            </form>
        {% endif %}

<script>
function confirmDelete(messageId) {
    if (confirm("Are you sure you want to delete this message?")) {
        var form = document.getElementById('deleteForm' + messageId);
        var confirmationInput = document.getElementById('confirmationInput' + messageId);
        confirmationInput.value = 'true';
        form.submit();
    }
}
</script>
      </div>
      {% endfor %}
    </div>
    <form
      action="{{ url_for('send_message', receiver_id=chat_user.id) }}"
      method="post"
      enctype="multipart/form-data"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <textarea name="content" required></textarea>
      <input type="file" name="files" multiple />
      <button type="submit">Send</button>
    </form>
    {% else %}
    <p>Select a friend to start chatting.</p>
    {% endif %}
  </div>
</div>

<div id="imageModal" class="modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="modalImage" />
</div>

<script>
function confirmDelete(messageId) {
    if (confirm("Are you sure you want to delete this message?")) {
        var form = document.getElementById('deleteForm' + messageId);
        var confirmationInput = document.getElementById('confirmationInput' + messageId);
        confirmationInput.value = 'true';
        form.submit();
    }
}
</script>

{% endblock %}
