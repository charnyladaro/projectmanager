<!DOCTYPE html>
<html>
  <head>
    <title>Project - {{ project.name }}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      let timers = {};

      function startTimer(taskId) {
        $.post("/start_timer/" + taskId, function (response) {
          if (response.success) {
            if (!timers[taskId]) {
              timers[taskId] = {
                startTime: Date.now(),
                elapsedTime: 0,
                interval: null,
              };
              timers[taskId].interval = setInterval(
                () => updateTimer(taskId),
                1000
              );
            } else {
              // Timer exists, but it might be paused
              if (!timers[taskId].interval) {
                timers[taskId].startTime =
                  Date.now() - timers[taskId].elapsedTime;
                timers[taskId].interval = setInterval(
                  () => updateTimer(taskId),
                  1000
                );
              }
            }
          }
        });
      }

      function pauseTimer(taskId) {
        $.post("/pause_timer/" + taskId, function (response) {
          if (response.success && timers[taskId] && timers[taskId].interval) {
            clearInterval(timers[taskId].interval);
            timers[taskId].elapsedTime = Date.now() - timers[taskId].startTime;
            timers[taskId].interval = null;
          }
        });
      }

      function stopTimer(taskId) {
        $.post("/stop_timer/" + taskId, function (response) {
          if (response.success && timers[taskId]) {
            clearInterval(timers[taskId].interval);
            const totalElapsedTime = Math.floor(
              (Date.now() - timers[taskId].startTime) / 1000
            ); // Convert milliseconds to seconds
            const timeLoggedElement = document.getElementById(
              `time-logged-${taskId}`
            );
            const currentLoggedTime = parseTimeString(
              timeLoggedElement.textContent
            );
            const newLoggedTime = currentLoggedTime + totalElapsedTime;
            timeLoggedElement.textContent = formatTime(newLoggedTime);

            // Clear timer display
            document.getElementById(`timer-display-${taskId}`).textContent =
              "00:00:00";

            // Hide start and pause buttons
            document.querySelector(`#start-${taskId}`).style.display = "none";
            document.querySelector(`#pause-${taskId}`).style.display = "none";

            // Change the stop button text to "Done"
            const stopButton = document.querySelector(`#stop-${taskId}`);
            stopButton.textContent = "Done";
            stopButton.disabled = true;

            delete timers[taskId];
          }
        });
      }

      function updateTimer(taskId) {
        const elapsedTime = Math.floor(
          (Date.now() - timers[taskId].startTime) / 1000
        ); // Convert milliseconds to seconds
        document.getElementById(`timer-display-${taskId}`).textContent =
          formatTime(elapsedTime);
      }

      function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hrs.toString().padStart(2, "0")}:${mins
          .toString()
          .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
      }

      function parseTimeString(timeString) {
        const parts = timeString.split(":").map(Number);
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      }

      function editTask(taskId) {
        var content = prompt("Edit your task:", $("#task-" + taskId).text());
        if (content) {
          $.ajax({
            url: "/update_task_name/" + taskId,
            type: "POST",
            data: { content: content },
            success: function (response) {
              alert("Task updated successfully!");
              $("#task-" + taskId).text(content);
            },
            error: function (error) {
              console.error("Error updating task:", error);
            },
          });
        }
      }

      function addComment(taskId) {
        var content = prompt("Enter your comment:");
        if (content) {
          $.ajax({
            url: "/add_comment/" + taskId,
            type: "POST",
            data: { content: content },
            success: function (response) {
              alert("Comment added successfully!");
              location.reload(); // Refresh page to display updated comments
            },
            error: function (error) {
              console.error("Error adding comment:", error);
            },
          });
        }
      }

      function editComment(commentId) {
        var content = prompt(
          "Edit your comment:",
          $("#comment-" + commentId).text()
        );
        if (content) {
          $.ajax({
            url: "/update_comment/" + commentId,
            type: "POST",
            data: { content: content },
            success: function (response) {
              alert("Comment updated successfully!");
              $("#comment-" + commentId).text(content);
            },
            error: function (error) {
              console.error("Error updating comment:", error);
            },
          });
        }
      }

      function deleteComment(commentId) {
        if (confirm("Are you sure you want to delete this comment?")) {
          $.ajax({
            url: "/delete_comment/" + commentId,
            type: "POST",
            success: function (response) {
              alert("Comment deleted successfully!");
              $("#comment-" + commentId).remove();
            },
            error: function (error) {
              console.error("Error deleting comment:", error);
            },
          });
        }
      }
    </script>
    <style>
      .taskName {
        border: 1px solid black;
        width: 250px;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <h1>{{ project.name }}</h1>
    <a href="{{ url_for('index') }}">Back to Projects</a>
    <h2>Tasks</h2>
    <form
      method="POST"
      action="{{ url_for('project', project_id=project.id) }}"
    >
      {{ form.hidden_tag() }}
      <p>
        {{ form.name.label }}<br />
        {{ form.name(size=32) }}<br />
        {% for error in form.name.errors %}
        <span style="color: red">[{{ error }}]</span><br />
        {% endfor %}
      </p>
      <p>{{ form.submit() }}</p>
    </form>
    <ul>
      {% for task in tasks %}
    <li id="task-{{ task.id }}" class="taskName">
        <a href="{{ url_for('task_detail', task_id=task.id) }}">{{ task.name }}</a>
    </li>


        <div class="timer-display" id="timer-display-{{ task.id }}">
          00:00:00
        </div>
        <div id="time-logged-{{ task.id }}">
          {{ task.total_time|format_time }}
        </div>
        <div class="timer-controls">
          <button
            id="start-{{task.id}}"
            class="btn timer-btn start"
            onclick="startTimer({{ task.id }})"
          >
            Start
          </button>
          <button
            id="pause-{{task.id}}"
            class="btn timer-btn pause"
            onclick="pauseTimer({{ task.id }})"
          >
            Pause
          </button>
          <button
            id="stop-{{ task.id }}"
            class="btn timer-btn stop"
            onclick="stopTimer({{ task.id }})"
          >
            Stop
          </button>
        </div>
        <button type="button" onclick="editTask({{ task.id }})">Edit</button>
        <form
          method="POST"
          action="{{ url_for('delete_task', task_id=task.id) }}"
          style="display: inline"
        >
          <button type="submit">Delete</button>
        </form>
        <button type="button" onclick="addComment({{ task.id }})">
          Add Comment
        </button>
        <ul>
          {% for comment in task.comments %}
          <li id="comment-{{ comment.id }}">
            {{ comment.content }}
            <form
              action="{{ url_for('upload_file', task_id=task.id) }}"
              method="post"
              enctype="multipart/form-data"
            >
              <input type="file" name="file" />
              <input type="submit" value="Upload" />
            </form>

            {% if task.file_path %}
            <div>
              <h3>Uploaded File:</h3>
              <a href="{{ url_for('static', filename=task.file_path) }}"
                >{{ task.file_path }}</a
              >
            </div>
            {% if task.file_path.split('.')[-1] in ['png', 'jpg', 'jpeg', 'gif']
            %}
            <img
              src="{{ url_for('static', filename=task.file_path) }}"
              alt="Task Image"
            />
            {% endif %} {% endif %}
            <button type="button" onclick="editComment({{ comment.id }})">
              Edit
            </button>
            <button type="button" onclick="deleteComment({{ comment.id }})">
              Delete
            </button>
          </li>
          {% endfor %}
        </ul>
      </li>
      {% endfor %}
    </ul>
  </body>
</html>
